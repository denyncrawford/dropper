function Dropper(a){var b=a.username,c=a.appName,d=a.password,e=a.apiKey,f=a.connect,g=f.domain||window.location.host,h=f.path||"/dropper",i=a.logs||!1,j="http://",k="ws://",l=f.secure||!1;if(!0==l&&(j="https://",k="wss://"),"/"!=h[0]&&(h="/"+h),!e||0==e.length)return void console.error("Please provide any apiKey in the options to connect the Droppet instance");var m,n=uuid(),o="?id="+n,p=new WebSocket(k+g+h+o),q=new EventEmitter,r=!1,s=!1,t=[];fetch(j+g+h+o,{method:"GET",mode:"cors",headers:{Authorization:e,"Content-Type":"application/json"}}).then(a=>a.json()).then(a=>{a.bool?(r=!1,s=!0):(p&&p.close(4001,"Unauthorized"),console.error(a.message),r=!0,s="fail")});var u=function(a){var b=a.data;isJson(b)&&(b=JSON.parse(b)),(!0==s||"connection"==b.event)&&q.emit("message",a.data)},v=function(a){q.emit("connect",{id:n,status:!0,message:"Connection stabilized"});var b=setInterval(()=>{if(!0==s){if(q.emit("open",a.data),0<t.length){for(var c=0;c<t.length;c++)p.send(t[c]);t=[]}m=setInterval(()=>{p.send("dropper:prevent")},25e3),clearInterval(b)}else"fail"==s&&clearInterval(b)},100)},w=function(a){r=!0;var b=a.code;if(clearInterval(m),1002==b||4e3<=b||1e3==b)return void q.emit("close",a);p=null;var c=setInterval(()=>{if(navigator.onLine&&r&&s)p=new WebSocket(k+g+h+o),p.onmessage=u,p.onopen=v,p.onclose=w,r=!1,clearInterval(c);else{if("fail"==s)return void clearInterval(c);console.log("Dropper is trying to reconnect...")}},100)};p.onmessage=u,p.onopen=v,p.onclose=w,this.emit=function(a,b){"undefined"==typeof b?(b=a,a=null,p.send(b)):r?(!0==s&&t.push(JSON.stringify({event:a,message:b})),console.error("The connection is closed, but Dropper added your data in the queue to be sent when reconnecting.")):!0==s&&p.send(JSON.stringify({event:a,message:b}))},this.close=function(a,b){p.close(a||1e3,b||"")},this.on=function(a,b){"connect"===a?q.on("connect",function(a){return b(a)}):"open"===a?q.on("open",function(a){return b(a)}):"message"===a?q.on("message",function(a){return isJson(a)&&(a=JSON.parse(a)),a.channel?void 0:b(a)}):"close"===a?q.on("close",function(a){return b(a)}):q.on("message",function(c){return isJson(c)&&(c=JSON.parse(c)),c.event?a==c.event?c.channel?void 0:b(c.message,c):void 0:b("Not event detected, try the default 'message' event to read raw data.")})},this.subscribe=function(a){return{bind:function(b,c){q.on("message",function(d){return isJson(d)&&(d=JSON.parse(d)),d.channel?d.channel==a?d.event==b?c(d.message):void 0:void 0:void 0})}}},this.trigger=function(a,b,c){return"undefined"==typeof a?console.log("Please provide a channel to use the trigger method."):void("undefined"==typeof c?(c=b,b=null,!0==s&&p.send(JSON.stringify({channel:a,message:c}))):!0==s&&p.send(JSON.stringify({channel:a,event:b,message:c})))}}function isJson(a){try{JSON.parse(a)}catch(a){return!1}return!0}var indexOf="function"==typeof Array.prototype.indexOf?function(a,b){return a.indexOf(b)}:function(a,b){for(var c=0,d=a.length,e=-1,f=!1;c<d&&!f;)a[c]===b&&(e=c,f=!0),c++;return e};var EventEmitter=function(){this.events={}};EventEmitter.prototype.on=function(a,b){"object"!=typeof this.events[a]&&(this.events[a]=[]),this.events[a].push(b)},EventEmitter.prototype.removeListener=function(a,b){var c;"object"==typeof this.events[a]&&(c=indexOf(this.events[a],b),-1<c&&this.events[a].splice(c,1))},EventEmitter.prototype.emit=function(a){var b,c,d,e=[].slice.call(arguments,1);if("object"==typeof this.events[a])for(c=this.events[a].slice(),d=c.length,b=0;b<d;b++)c[b].apply(this,e)},EventEmitter.prototype.once=function(a,b){this.on(a,function c(){this.removeListener(a,c),b.apply(this,arguments)})};function uuid(){var a=new Date().getTime(),b=performance&&performance.now&&1e3*performance.now()||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(d){var c=16*Math.random();return 0<a?(c=0|(a+c)%16,a=Math.floor(a/16)):(c=0|(b+c)%16,b=Math.floor(b/16)),("x"===d?c:8|3&c).toString(16)})}
